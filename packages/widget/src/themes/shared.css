/* =========================================================
   VALKI — Theme + Layout Locks
========================================================= */
#valki-root{
  /* Theme */
  --bg: #0b0b0b;
  --surface: rgba(255,255,255,.04);
  --surface-2: rgba(255,255,255,.06);
  --border: rgba(255,255,255,.10);
  --border-2: rgba(255,255,255,.16);
  --text: rgba(255,255,255,.92);
  --muted: rgba(255,255,255,.60);
  --muted-2: rgba(255,255,255,.45);

  --brand: #f15a24;
  --brand-2: #ff7a45;
  --ring: rgba(241,90,36,.22);
  --chat-accent: 241,90,36;
  --sources-dot-rgb: 241,90,36; /* #F15A24 (pinned, independent of chat accent) */

  --btn-fill: #e7e7e7;
  --btn-text: #0b0b0b;

  /* HARD layout lock (ChatGPT feel) */
  --col: 760px;
  --gutter: 24px;

  --radius: 14px;
  --radius-pill: 999px;

  --shadow-1: 0 12px 40px rgba(0,0,0,.55);
  --shadow-2: 0 20px 70px rgba(0,0,0,.70);
  --valki-backdrop: rgba(0,0,0,.35);
  --valki-backdrop-fallback: rgba(0,0,0,.55);
  --valki-backdrop-blur: 10px;
  --valki-panel-bg: rgba(12,12,12,.92);
  --valki-panel-border: rgba(255,255,255,.06);
  --valki-panel-shadow: 0 30px 70px rgba(0,0,0,.55);
  --valki-panel-frame-border-soft: rgba(255,255,255,.04);
  --valki-panel-frame-shadow-soft: 0 18px 50px rgba(0,0,0,.38);
  --valki-panel-frame-border-none: transparent;
  --valki-panel-frame-shadow-none: none;
  --valki-panel-frame-border: var(--valki-panel-frame-border-soft);
  --valki-panel-frame-shadow: var(--valki-panel-frame-shadow-soft);

  --font: system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text",Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  -webkit-text-size-adjust: 100%;

  --valki-vh: 1dvh;
  --vvh: calc(var(--valki-vh, 1vh) * 100);

  /* (Fallback) composer height – als je later JS toevoegt kan dit dynamisch */
  --composer-h: 110px;

  --valki-chat-pad-bottom: calc(env(safe-area-inset-bottom) + 10px);
  --keyboard-bottom: 0px;

  /* Background + vignette + blur */
  --chat-bg-image: url("https://valki.wiki/onewebmedia/Valki%20Talki%20chat.jpg");
  --chat-bg-color: #070707;

  --vignette-strength: .58;  /* iets steviger voor blok-contrast */
  --side-blur: 30px;
  --side-tint: rgba(0,0,0,.18); /* transparanter zodat bg sterker doorkomt */

  /* Chat block */
  --chat-block-bg: rgba(8,8,8,.78);           /* massief blok */
  --chat-block-border: rgba(255,255,255,.10);
  --chat-block-blur: 10px;
}

@supports (height: 100dvh){
  #valki-root{
    --vvh: min(calc(var(--valki-vh, 1vh) * 100), 100dvh);
  }
}

#valki-root, #valki-root *{ box-sizing:border-box; }

#valki-root [data-panel-frame="none"]{
  --valki-panel-frame-border: var(--valki-panel-frame-border-none);
  --valki-panel-frame-shadow: var(--valki-panel-frame-shadow-none);
}

#valki-root [data-panel-frame="soft"]{
  --valki-panel-frame-border: var(--valki-panel-frame-border-soft);
  --valki-panel-frame-shadow: var(--valki-panel-frame-shadow-soft);
}

#valki-root button{
  all: unset;
  box-sizing:border-box;
  font: inherit;
  color: inherit;
  cursor:pointer;
}

/* iOS caret metrics: avoid all: unset on inputs/textareas. */
#valki-root input,
#valki-root textarea{
  -webkit-appearance: none;
  appearance: none;
  box-sizing: border-box;
  font: inherit;
  color: inherit;
  border: 0;
  margin: 0;
  padding: 0;
  background: transparent;
  display: block;
}

#valki-root input, #valki-root textarea{ cursor:text; }

/* Focus ring alleen voor knoppen (keyboard users) */
#valki-root button:focus-visible{
  outline: 1px solid var(--brand);
  outline-offset: 1px;
}

/* Geen oranje outline op input/textarea */
#valki-root input:focus-visible,
#valki-root textarea:focus-visible{
  outline: none !important;
}

#valki-root ::selection{ background: rgba(140,170,255,.14); }
#valki-root ::-moz-selection{ background: rgba(140,170,255,.14); }

@supports (-webkit-touch-callout: none){
  #valki-root input, #valki-root textarea{ font-size:16px; }
}

/* Hide background when modal is open to avoid double-blur look */
html.valki-chat-open #valki-root #valki-bg{
  display:none !important;
}

/* =========================================================
   Root container
========================================================= */
#valki-root{
  position:relative;
  z-index:1;
  min-height:var(--vvh);
  width:100%;
  margin:0;
  padding: env(safe-area-inset-top) 0 0;
  background: transparent;
  color: var(--text);
  font-family: var(--font);
}

/* =========================================================
   Floating Chat Bubble Launcher (Beautiful)
========================================================= */
#valki-root .valki-bubble{
  position: fixed;
  right: var(--widget-launcher-right, 18px);
  bottom: var(--widget-launcher-bottom, calc(18px + env(safe-area-inset-bottom)));
  width: var(--widget-launcher-bubble-size, 64px);
  height: var(--widget-launcher-bubble-size, 64px);
  border-radius: 999px;

  /* Subtle gradient + inner ring */
  background:
    radial-gradient(140% 140% at 30% 25%, rgba(255,255,255,.28), rgba(255,255,255,0) 45%),
    linear-gradient(145deg, var(--brand-2), var(--brand));
  box-shadow:
    0 26px 70px rgba(0,0,0,.62),
    0 0 0 1px rgba(255,255,255,.18) inset,
    0 8px 24px rgba(241,90,36,.22);

  display:flex;
  align-items:center;
  justify-content:center;

  z-index: var(--widget-launcher-z, 2147482998);
  transform: translateZ(0);
  transition: transform .16s ease, box-shadow .16s ease, filter .16s ease;
}

#valki-root .valki-bubble:hover{
  transform: translateY(-2px);
  filter: brightness(1.04);
  box-shadow:
    0 30px 85px rgba(0,0,0,.68),
    0 0 0 1px rgba(255,255,255,.22) inset,
    0 10px 32px rgba(241,90,36,.26);
}

#valki-root .valki-bubble:active{
  transform: translateY(0px) scale(.99);
}

#valki-root .valki-bubble-icon{
  width: 28px;
  height: 28px;
  color: rgba(255,255,255,.96);
  filter: drop-shadow(0 8px 12px rgba(0,0,0,.35));
}

#valki-root .valki-bubble-badge{
  position:absolute;
  top: 10px;
  right: 10px;
  min-width: 18px;
  height: 18px;
  padding: 0 5px;
  border-radius: 999px;
  background: #ff3b30;
  color: #fff;
  font-size: 11px;
  font-weight: 800;
  letter-spacing: -.02em;
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow: 0 14px 26px rgba(0,0,0,.55);
  border: 1px solid rgba(255,255,255,.22);
}

#valki-root .valki-bubble-ping{
  position:absolute;
  inset: -6px;
  border-radius: 999px;
  border: 2px solid rgba(241,90,36,.35);
  animation: valkiPing 2.2s infinite;
  pointer-events:none;
  opacity:.8;
}

@keyframes valkiPing{
  0%{ transform: scale(.90); opacity:.45; }
  65%{ transform: scale(1.10); opacity:0; }
  100%{ transform: scale(1.10); opacity:0; }
}

/* Hide bubble while chat is open */
html.valki-chat-open #valki-root .valki-bubble{
  opacity: 0;
  pointer-events:none;
  transform: translateY(10px);
}

/* =========================================================
   Overlays / Fullscreen chat (iOS/rotate/keyboard-proof)
   - Uses your JS-driven --vvh (via --valki-vh)
========================================================= */

/* Make sure the actual overlay nodes sit above everything */
#valki-root #valki-overlay,
#valki-root #valki-auth-overlay,
#valki-root #valki-confirm-overlay,
#valki-root #valki-logout-overlay{
  z-index: var(--widget-overlay-z, 2147483000) !important;
}

/* Base overlay layout */
#valki-root .valki-overlay,
#valki-root .valki-auth-overlay,
#valki-root .valki-confirm-overlay,
#valki-root .valki-logout-overlay{
  position: fixed;
  inset: 0;
  overflow: hidden;

  /* IMPORTANT: var(--vvh) = calc(var(--valki-vh) * 100) */
  height: min(var(--vvh), 100dvh);
  width: 100%;

  /* default hidden state */
  display: none;
  opacity: 0;
  pointer-events: none;

  /* nice fade */
  transition: opacity .18s ease;
  isolation: isolate;

  background: var(--bg);

  /* flex baseline (enabled when .is-visible) */
  align-items: stretch;
  justify-content: center;
}

/* Main chat overlay fills vertically */
#valki-root .valki-overlay{
  align-items: stretch;
  justify-content: center;
}

/* Centered overlays (auth/confirm/logout) */
#valki-root .valki-auth-overlay,
#valki-root .valki-confirm-overlay,
#valki-root .valki-logout-overlay{
  background: rgba(0,0,0,.82);
  align-items: center;
  justify-content: center;
}

@media (min-width: 1024px){
  #valki-root #valki-overlay[data-layout="desktop"]{
    background: var(--valki-backdrop);
    backdrop-filter: blur(var(--valki-backdrop-blur));
    -webkit-backdrop-filter: blur(var(--valki-backdrop-blur));
  }
}

@supports not ((backdrop-filter: blur(1px)) or (-webkit-backdrop-filter: blur(1px))){
  @media (min-width: 1024px){
    #valki-root #valki-overlay[data-layout="desktop"]{
      background: var(--valki-backdrop-fallback);
    }
  }
}

/* Fullscreen modal follows the same vh logic */
#valki-root .valki-modal{
  height: min(var(--vvh), 100dvh);
  width: 100%;
  display: flex;
  flex-direction: column;
  position: relative;
  min-height: 0;
}

#valki-root .valki-chat-shell{
  height: min(var(--vvh), 100dvh);
  width: 100%;
  display: flex;
  flex-direction: column;
  min-height: 0;
}

#valki-root .valki-sidebar{
  display: none;
  flex-direction: column;
  min-height: 0;
  width: 100%;
}

/* Visible state */
#valki-root .valki-overlay.is-visible,
#valki-root .valki-auth-overlay.is-visible,
#valki-root .valki-confirm-overlay.is-visible,
#valki-root .valki-logout-overlay.is-visible{
  display: flex;
  opacity: 1;
  pointer-events: auto;
}

/* ===============================
   STREAMING — CHECKING SOURCES
================================ */

#valki-root .valki-sources-overlay{
  position: absolute;
  inset: 0;
  display: none;
  align-items: flex-end;
  justify-content: flex-start;
  padding: 24px;
  opacity: 0;
  pointer-events: none;
  transform: translateY(8px);
  transition: opacity 160ms ease, transform 160ms ease;
  z-index: 8;
}

#valki-root .valki-sources-overlay.is-visible{
  display: flex;
  opacity: 1;
  transform: translateY(0);
}

#valki-root .valki-sources-card{
  display: inline-flex;
  align-items: center;
  gap: 12px;
  padding: 14px 18px;
  border-radius: 18px;
  background: rgba(16,16,16,.6);
  border: 1px solid rgba(var(--chat-accent), .24);
  box-shadow: 0 14px 40px rgba(0,0,0,.45), 0 0 0 1px rgba(var(--chat-accent), .08), 0 10px 22px rgba(var(--chat-accent), .12);
  color: var(--text);
  font-weight: 600;
  letter-spacing: 0.2px;
  backdrop-filter: blur(16px) saturate(140%);
  -webkit-backdrop-filter: blur(16px) saturate(140%);
}

#valki-root .valki-sources-dot{
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: radial-gradient(
    circle at 30% 30%,
    rgba(255,255,255,.75),
    rgba(var(--sources-dot-rgb), .85) 40%,
    rgba(var(--sources-dot-rgb), .9)
  );
  box-shadow: 0 0 16px rgba(var(--sources-dot-rgb), .45);
  animation: valki-sources-pulse 1.4s ease-in-out infinite;
}

#valki-root .valki-sources-label{
  font-size: 0.98rem;
}

#valki-root .valki-sources-ellipsis{
  display: inline-block;
  min-width: 1.4em;
  color: currentColor;
  opacity: 1;
}

@keyframes valki-sources-pulse{
  0%, 100%{
    transform: scale(1);
    opacity: 0.9;
  }
  50%{
    transform: scale(1.08);
    opacity: 1;
  }
}

@keyframes valki-sources-shimmer{
  0%{
    transform: translateX(-60%);
    opacity: 0.35;
  }
  50%{
    opacity: 0.7;
  }
  100%{
    transform: translateX(60%);
    opacity: 0.35;
  }
}

@media (prefers-reduced-motion: reduce){
  #valki-root .valki-sources-overlay{
    transition: none;
  }
  #valki-root .valki-sources-dot{
    animation: none;
  }
  #valki-root .valki-msg-row.bot.valki-sources-placeholder .valki-msg-bubble::after{
    animation: none;
  }
}

/* ===============================
   AUTH MODAL – FIXED CARD LAYOUT
================================ */

#valki-root .valki-auth-modal{
  width: 100%;
  max-width: 420px;
  margin: 0 16px;

  background: rgba(12,12,12,.92);
  backdrop-filter: blur(18px) saturate(120%);
  -webkit-backdrop-filter: blur(18px) saturate(120%);

  border-radius: 18px;
  border: 1px solid rgba(255,255,255,.14);
  box-shadow: 0 30px 90px rgba(0,0,0,.65);

  padding: 22px 22px 20px;
  text-align: center;

  display: flex;
  flex-direction: column;
  align-items: center;
}

/* Avatar/logo bovenin netjes klein */
#valki-root .valki-auth-avatar{
  width: 72px;
  height: 72px;
  border-radius: 50%;
  margin-bottom: 14px;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.04);
}

/* Titel */
#valki-root .valki-auth-title{
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 6px;
}

/* Subtitel */
#valki-root .valki-auth-subtitle{
  font-size: 13px;
  color: rgba(255,255,255,.65);
  margin-bottom: 18px;
}

/* Buttons stack */
#valki-root .valki-auth-buttons{
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-bottom: 14px;
}

/* Buttons */
#valki-root .valki-auth-btn{
  width: 100%;
  padding: 10px 14px;
  border-radius: 12px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.14);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  font-size: 14px;
}

#valki-root .valki-auth-btn.primary{
  background: #f2f2f2;
  color: #0b0b0b;
}

#valki-root .valki-auth-btn.danger{
  background: #ff4b4b;
  border-color: rgba(255,255,255,.18);
  color: #fff;
}

/* Footer tekst */
#valki-root .valki-auth-note{
  font-size: 11px;
  color: rgba(255,255,255,.55);
  margin-bottom: 8px;
}

/* Dismiss */
#valki-root .valki-auth-dismiss{
  font-size: 12px;
  color: rgba(255,255,255,.7);
  cursor: pointer;
}

/* ===============================
   AUTH BUTTON HOVER – FIXED
================================ */

#valki-root .valki-auth-btn{
  cursor: pointer;
  transition:
    transform .12s ease,
    box-shadow .12s ease,
    border-color .12s ease,
    background .12s ease,
    filter .12s ease;
}

/* ---------- DEFAULT (dark buttons) ---------- */
@media (hover:hover){
  #valki-root .valki-auth-btn:not(.primary):hover{
    transform: translateY(-1px);
    background: rgba(255,255,255,.09);
    border-color: rgba(255,255,255,.22);
    box-shadow: 0 14px 34px rgba(0,0,0,.35);
  }
}

/* ---------- PRIMARY (white button) ---------- */
@media (hover:hover){
  #valki-root .valki-auth-btn.primary:hover{
    transform: translateY(-1px);
    background: #f2f2f2;              /* blijft wit */
    border-color: rgba(0,0,0,.08);
    box-shadow: 0 18px 44px rgba(0,0,0,.38);
    filter: brightness(1.01);         /* subtiel, geen grijs */
  }
}

@media (hover:hover){
  #valki-root .valki-auth-btn.danger:hover{
    transform: translateY(-1px);
    background: #ff5c5c;
    border-color: rgba(255,255,255,.28);
    box-shadow: 0 18px 44px rgba(0,0,0,.38);
  }
}

/* Pressed */
#valki-root .valki-auth-btn:active{
  transform: translateY(0) scale(.99);
}

/* Keyboard focus */
#valki-root .valki-auth-btn:focus-visible{
  outline: none;
  box-shadow:
    0 0 0 2px var(--ring),
    0 18px 44px rgba(0,0,0,.38);
}

/* =========================================================
   Modal + Background + Vignette + Side Blur  (FIX)
========================================================= */
#valki-root .valki-modal{
  width:100%;
  height: min(var(--vvh), 100dvh);

  /* IMPORTANT: use your background image variable */
  background:
    var(--chat-bg-image) center / cover no-repeat,
    linear-gradient(#0c0c0c,#070707);
  background-color: var(--chat-bg-color);

  border-radius:0;
  overflow:hidden;
  display:flex;
  flex-direction:column;

  position: relative;
  isolation: isolate;

  /* Outer block presence */
  box-shadow:
    0 0 0 1px rgba(255,255,255,.04),
    0 30px 80px rgba(0,0,0,.65);
}

/* =========================================================
   VIGNETTE + SIDE BLUR OUTSIDE CHAT BLOCK (REPLACES OLD ::before/::after)
========================================================= */

/* Put vignette inside modal background layers */
#valki-root .valki-modal{
  background:
    /* Vignette */
    radial-gradient(
      120% 100% at 50% 45%,
      rgba(0,0,0,0) 0%,
      rgba(0,0,0,0) 42%,
      rgba(0,0,0, calc(var(--vignette-strength, .58) * .42)) 68%,
      rgba(0,0,0, var(--vignette-strength, .58)) 100%
    ),
    /* Your background image */
    var(--chat-bg-image) center / cover no-repeat,
    /* Fallback */
    linear-gradient(#0c0c0c,#070707);

  background-color: var(--chat-bg-color, #070707);

  position: relative;
  isolation: isolate;

  /* Calculate chat block width (col + 2*gutter) */
  --chat-block-w: min(100vw, calc(var(--col) + (var(--gutter) * 2)));
  --side-w: max(0px, calc((100vw - var(--chat-block-w)) / 2));
}

/* LEFT side blur panel */
#valki-root .valki-modal::before{
  content:"";
  position:absolute;
  top:0;
  bottom:0;
  left:0;
  width: var(--side-w);
  z-index:1;
  pointer-events:none;

  background: rgba(0,0,0,.18); /* transparant maar definieert de blur-zone */
  backdrop-filter: blur(var(--side-blur, 18px)) saturate(115%);
  -webkit-backdrop-filter: blur(var(--side-blur, 18px)) saturate(115%);

  box-shadow: inset -1px 0 rgba(255,255,255,.06);
}

/* RIGHT side blur panel */
#valki-root .valki-modal::after{
  content:"";
  position:absolute;
  top:0;
  bottom:0;
  right:0;
  width: var(--side-w);
  z-index:1;
  pointer-events:none;

  background: rgba(0,0,0,.18);
  backdrop-filter: blur(var(--side-blur, 18px)) saturate(115%);
  -webkit-backdrop-filter: blur(var(--side-blur, 18px)) saturate(115%);

  box-shadow: inset 1px 0 rgba(255,255,255,.06);
}

/* Keep real UI above blur panels */
#valki-root .valki-modal > *{
  position: relative;
  z-index: 2;
}

/* Mobile: disable side blur panels */
@media (max-width: 640px){
  #valki-root .valki-modal::before,
  #valki-root .valki-modal::after{
    display:none;
  }
}

/* Ensure actual UI sits above overlays */
#valki-root .valki-modal > *{
  position: relative;
  z-index: 2;
}

/* =========================================================
   Header — HARD column lock
========================================================= */
#valki-root .valki-modal-header{
  padding: calc(10px + env(safe-area-inset-top)) var(--gutter) 10px;
  border-bottom: 1px solid rgba(255,255,255,.08);

  /* Let block styling control background */
  background: transparent;
  backdrop-filter: none;
}

#valki-root .valki-modal-header-inner{
  max-width: var(--col) !important;
  width: 100% !important;
  margin: 0 auto !important;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 12px;
  padding-left: 0 !important;
  padding-right: 0 !important;
}

#valki-root .valki-header-left{ display:flex; align-items:center; gap: 10px; min-width:0; }

#valki-root .valki-agent-back{
  width:30px;height:30px;
  border-radius:50%;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  display:none;
  align-items:center;
  justify-content:center;
  color: rgba(255,255,255,.9);
}

#valki-root .valki-header-avatar{
  width:30px;height:30px;border-radius:50%;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.05);
  flex:0 0 auto;
}

#valki-root .valki-modal-title-text{ display:flex; flex-direction:column; min-width:0; }
#valki-root .valki-modal-title-text .name{
  font-size: 14px;
  font-weight: 720;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
#valki-root .valki-modal-title-text .session{
  font-size: 11px;
  color: var(--muted-2);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

#valki-root .valki-header-actions{ display:flex; align-items:center; gap: 8px; }

#valki-root .valki-pill{
  padding: 7px 10px;
  border-radius: var(--radius-pill);
  background: rgba(255,255,255,.04);
  border: 1px solid rgba(255,255,255,.10);
  font-size: 12px;
  color: rgba(255,255,255,.86);
  transition: transform .12s ease, background .12s ease, border-color .12s ease;
}

... (file continues)